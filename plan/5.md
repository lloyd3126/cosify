# 歷史候選持久化：原子化任務清單

目標：將每個步驟生成的所有變體持久化到資料庫，歷史頁與 Modal 可列出/採用，不影響現有功能，分階段落地。

---

## 0. 前置與基準
- [ ] 建立開發分支 `feat/persist-step-assets`
- [ ] 記錄現況基準（生成成功、3x、清除 Plan A、Modal/Lightbox）
- [ ] 確認可執行遷移（Drizzle）與本地 DB 可 reset

## 1. Schema（DB）
- [ ] 新增表 `runs`（若需）：id, slug, status, createdAt, updatedAt（可重用現有 flow_runs，如無必要可略過）
- [ ] 新增表 `run_steps`：runId+stepId（pk）、kind、adoptedAssetId（fk）、createdAt、updatedAt
- [ ] 新增表 `step_assets`（關鍵）：
      - id（pk, ulid/uuid）
      - runId, stepId（索引）
      - r2Key（unique(runId,stepId,r2Key)）
      - status('done'|'error'), temperature?, model?, prompt?, meta(JSON)?
      - createdAt
- [ ] 為 run_steps.adoptedAssetId 建立外鍵至 step_assets.id
- [ ] 產生與套用遷移檔（Drizzle）

## 2. 後端 API
- [ ] 建立 `POST /api/runs/{runId}/steps/{stepId}/assets`（建立資產）
      - 寫入 step_assets（若 unique 衝突則返回既有紀錄）
      - 回傳 asset（含 id, r2Key, temperature, createdAt）
- [ ] 建立 `GET /api/runs/{runId}/steps/{stepId}/assets`（列表）
      - 支援 cursor/limit，createdAt DESC
      - 回傳 { assets, adoptedAssetId }
- [ ] 建立 `POST /api/runs/{runId}/steps/{stepId}/adopt`（設定採用）
      - body: { assetId }
      - 驗證 asset 屬於 runId+stepId
      - 更新 run_steps.adoptedAssetId，回傳 { adoptedAssetId, adoptedKey }
- [ ] 建立（可選）`POST /api/runs/{runId}/steps/{stepId}/clear`（清除採用，不刪資產）
      - 將 run_steps.adoptedAssetId 設為 null

## 3. 整合生成流程（寫庫）
- [ ] 在 `POST /api/flows/[slug]/steps/[stepId]/generate` 完成後：
      - 取得 runId, stepId, r2Key, temperature, model, prompt
      - 呼叫內部 service 寫入 step_assets（或直接插入）
      - 回傳沿用現有 { key }，並可附加 { assetId }
- [ ] 確保 3x 串行三張都各自寫入 step_assets
- [ ] 補單一測試：單張/3x 生成後 DB 各出 1/3 筆 assets

## 4. 前端（階段 1：零變更驗收）
- [ ] 維持現行 UI/queue 行為不變
- [ ] 僅驗證生成後 DB 已有 assets（透過簡單頁面或 API 測試）

## 5. 前端（階段 2：Modal 合流）
- [ ] 打開 Modal 時呼叫 `GET .../assets` 取得 done 清單與 adoptedAssetId
- [ ] 與本地 generationQueue 合併渲染：
      - queued/running/error：用本地 queue
      - done：以 DB assets 為準（以 r2Key 去重）
- [ ] 採用按鈕：
      - 呼叫 `POST .../adopt` 後，更新 keys[stepId] 與前端 adopted 標記
      - 保留本地即時 setKeys，以維持秒回感
- [ ] 計數顯示：queue.length（如有）+ DB done 數

## 6. 歷史頁（階段 3）
- [ ] 歷史頁讀取 runs → steps → assets
- [ ] 展開 assets 縮圖格、顯示溫度/時間
- [ ] 提供採用、下載（與 Modal 一致）

## 7. 清除與一致性
- [ ] 清除（Plan A）：
      - 保留 step_assets，不清空
      - 僅清除當前採用並使下游失效（沿用現有 invalidateFrom）
- [ ] 併發安全：維持前端 opId 防護；後端 adopt 僅更新單欄位
- [ ] 去重保證：unique(runId,stepId,r2Key)

## 8. 資料品質與維運（之後）
- [ ] meta 擴充：width/height/sizeBytes/hash
- [ ] 清理策略：保留最近 N 筆或按時間淘汰
- [ ] 批次刪除 API（可選）

## 9. 驗收清單
- [ ] 單張/3x 生成 → step_assets 寫入 1/3 筆
- [ ] Modal 合流顯示 DB done + 本地 queue，占位與已完成並存
- [ ] 採用與清除按既有 UX 運作（卡片即時更新、下游失效）
- [ ] 歷史頁可展開候選並改採用
