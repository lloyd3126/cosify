# Cosify UI/流程改版 — 原子任務清單

更新日期：2025-08-30

目標：把首頁改造成三欄上傳/結果流程（角色圖、使用者圖、結果圖），並提供生成與下載；其後逐步強化體驗與產品化。

---

## P0｜必做（達成附圖體驗）

1) 整併目錄與來源唯一化（避免 `app/` 與 `src/app/` 混用）
- [ ] 僅保留 `app/` 為入口；確認 `app/layout.tsx` + `app/page.tsx` 為生效版本
- [ ] 移除或註明 `src/app/` 下重複檔（避免誤編輯）
- [ ] 檢查/修正匯入路徑（例如 `@/components/navbar`、`./globals.css`）
- 驗收：啟動 dev server 能渲染 `app/page.tsx`，且不存在兩份 page/layout 競爭

2) 建立可重用上傳卡 UploadCard（拖放/點擊上傳 + 預覽 + 清除）
- [ ] Prop：`label`, `file`, `onChange(file|null)`, `accept`, `maxSizeMB`
- [ ] 支援拖放與按鈕選檔；限制 `image/*` 與大小（超出提示錯誤）
- [ ] 圖片預覽（objectURL）與清除按鈕
- [ ] 無障礙：`aria-label`、鍵盤操作、聚焦樣式

3) 首頁三欄版面與狀態（左：角色／中：使用者／右：結果）
- [ ] 兩張上傳卡分別綁定 `characterFile` 與 `selfFile`
- [ ] 結果卡三態：idle（灰底占位）、loading（Spinner）、done（顯示結果圖）
- [ ] 按鈕列：
	- [ ] 生成：需登入且兩張圖齊全才啟用；生成中 disabled
	- [ ] 下載：有結果圖才啟用

4) 串接生成流程（/api/generate）
- [ ] 未登入（401）→ 顯示「請先登入」提示（Navbar 已含 Google 登入）
- [ ] 上傳 `FormData(self, character)`；本地進度條（10→35→80→100）+ 結果卡 Spinner
- [ ] 成功：保存 `finalKey`，結果卡顯示 `/api/r2/${key}` 圖
- [ ] 錯誤：toast 顯示、復原狀態且保留已選檔案

5) 下載功能
- [ ] 以 blob 下載結果圖，檔名：`cosify-YYYYMMDD-HHmmss.png`
- [ ] 錯誤提示與可重試

6) R2 回應快取
- [ ] `app/api/r2/[...key]/route.ts` 加上 `Cache-Control: public, max-age=31536000, immutable`
- 驗收：Network headers 顯示 immutable 快取

完成定義（P0）：
- [ ] 本地 `bun run dev` 啟動無錯誤、Lint/Build 通過
- [ ] 三欄互動符合附圖：idle/選檔/生成中/成功/下載
- [ ] 未登入 → 友善提示；登入後可正常生成

---

## P1｜體驗增強（非阻斷）

7) 前端圖片預處理
- [ ] 讀檔時矯正 EXIF 旋轉
- [ ] 限制最長邊（例如 1536–2048px），視情況輸出 webp/png
- [ ] 壓縮品質控制與檔型選擇；失敗則回退原檔

8) 顯示生成階段/中間成果（可選）
- [ ] API 回傳 `intermediateKey`、`outfitKey`
- [ ] UI 顯示小縮圖或 Stepper 指示三階段完成度

9) 取消/重試機制
- [ ] 使用 `AbortController` 中止請求
- [ ] UI 顯示已取消與重試按鈕

---

## P2｜產品化與控管

10) 生成紀錄（DB）
- [ ] `twoStageGenerate` 或 API 路由寫入 `generations`（userId、keys、狀態、錯誤）
- [ ] 歷史頁面：列表、預覽、再次下載

11) 配額與風險控管
- [ ] 以 userId 做每日次數限制與尺寸上限
- [ ] 基本防濫用檢查（副檔名/實際 MIME、像素與大小閾值）

12) 文件與品質
- [ ] README：環境變數、啟動步驟、限制與注意事項
- [ ] Lint/Build 綠燈；新增基本渲染測試（首頁可渲染、按鈕狀態切換）

---

備註：
- 現行 API 僅回 `finalKey`，若要顯示中間階段，需增回傳欄位。
- 大圖上傳將拉長生成時間；建議優先完成 P1 的預處理以改善體感。

