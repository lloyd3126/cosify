# 專案計劃：三張卡片拓展為六張卡片（原子性任務清單）

本清單聚焦可直接執行的最小任務，支援以下既定規格：
- 介面採卡片輪播樣式，但不提供內建 Carousel 導航；由外側兩個 icon（CircleChevronLeft/Right）控制前後張。
- 逐步操作、不可跳步；未完成當前步驟前不可前進。
- 第6步為髮型替換（非僅髮色）。
- 每一步的產物可下載，下載檔名為 UUID.png，重跑覆蓋同一步結果。
- 重跑前顯示 Alert 說明覆蓋與下游失效。

---

## A. 規格與設計（無程式變更）
1. 定義六步流程對應與依賴圖（1→3→4→5→6；2→5→6）。
2. 撰寫每一步的完成條件（Step1/2=有檔案；Step3=intermediateKey；Step4=outfitKey；Step5=stage3Key；Step6=finalKey）。
3. 撰寫未解鎖提示字串清單（每步缺什麼就顯示什麼）。
4. 撰寫重跑覆蓋的 Alert 文字（標題、內容、按鈕文案）。
5. 定義外側導航 icon 的尺寸、位置、可觸區與鍵盤可及性（左右鍵）。
6. 定義「自動導回最早未完成步驟」的規則（清除或重跑成功後）。
7. 定義每步的下載檔名規則（固定 UUID）與後端回應/前端請求的 cache 規格（no-store）。

## B. UI 元件與狀態（前端）
8. 建立外側導航容器與左右兩個控制按鈕（CircleChevronLeft/Right），加上 aria-label 與鍵盤事件處理。
9. 建立六個卡片子元件/狀態區塊的骨架（不含最終資料串接）：
   - Step1 上傳想扮演的角色照
   - Step2 上傳扮演者的全身照
   - Step3 生成角色的扮演照（Stage1）
   - Step4 生成角色的扮演服（Stage2）
   - Step5 生成扮演者的角色扮演照（Stage3）
   - Step6 更換扮演者的髮型（Stage4）
10. 實作每步的控制區域：主要按鈕（生成/重新生成）、下載、清除（先以假資料/事件）。
11. 實作每步的狀態機：idle/processing/done/error，與按鈕啟用條件與禁用原因顯示。
12. 實作依賴無效化：當上游變動或清除時，自動清空下游結果並鎖定按鈕。
13. 實作「未完成禁止前進」：下一張按鈕的啟用條件綁定當前步是否完成。
14. 實作「返回上一張」：上一張按鈕在 Step1 停用，其他步啟用。
15. 實作「自動導回最早未完成步驟」：清除或重跑成功後執行導引。
16. 實作下載按鈕：以 UUID 為檔名下載對應結果（先串接至既有 /api/r2/[...key] 或 stub）。
17. 實作重跑 Alert：覆蓋提示對話框與確認流程（不含 API 呼叫）。

## C. API 分步契約與串接（後端與前端）
18. 設計分步端點：
	- POST /api/generate/stage1: body: character | out: intermediateKey, stepUuid
	- POST /api/generate/stage2: body: intermediateKey | out: outfitKey, stepUuid
	- POST /api/generate/stage3: body: user, outfitKey | out: stage3Key, stepUuid
	- POST /api/generate/stage4: body: stage3Key, character | out: finalKey, stepUuid
19. 決定 UUID 生成與保存策略：每步固定 stepUuid；重跑覆蓋相同 <stage>/<stepUuid>.png。
20. 後端回應包含：key 與 stepUuid；HTTP 設定 no-store；錯誤訊息統一格式。
21. 前端串接各步 API：發送表單/JSON，接收 key、更新預覽、解鎖下一步。
22. 前端重跑：呼叫相同步驟端點，覆蓋結果後執行下游無效化與導回規則。
23. 下載：以 key 走 /api/r2/[...key]；下載檔名使用 stepUuid.png。

## D. 資料狀態與一致性
24. 建立全域狀態（或 React Context）儲存：
	- selfOriginalKey、characterOriginalKey
	- intermediateKey、outfitKey、stage3Key、finalKey
	- 各步 stepUuid 與步驟完成旗標
25. 定義狀態重置規則：上游清除/變更即清空下游 key 與完成旗標。
26. 定義錯誤狀態：保存錯誤碼/訊息，提供重試與導引。
27. 定義載入節流與中止：避免重複送出與競態（顯示處理中）。

## E. 無障礙與回饋
28. 導航按鈕提供鍵盤操作與 ARIA 狀態（disabled 原因以 aria-disabled + 說明）。
29. 生成中提供可感知的 Loading 指示；完成提供成功提示（可用 toast）。
30. 下載與覆蓋成功的回饋（toast 或訊息條）。

## F. 驗收準則（Acceptance）
31. 僅外側兩個 icon 控制前/後，無點點或步驟條。
32. 不可跳步；未完成步驟前無法前進。
33. 每步完成後可下載，檔名為 UUID.png。
34. 重跑前有 Alert 說明；確認後覆蓋同一步結果並使下游失效。
35. 第6步執行髮型替換（Stage4 提示詞），非僅髮色。
36. 清除與重跑後自動導回最早未完成步驟。

## G. 發布前檢查
37. Lint/型別通過，無未使用變數與 TS 錯誤。
38. 基本 E2E 手動腳本：能從 Step1 走到 Step6，並測試清除/重跑/下載行為。
39. 錯誤保護：未登入禁止生成，顯示清楚訊息；API 錯誤能被前端正確顯示與重試。

