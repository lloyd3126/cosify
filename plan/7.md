# 實作計劃：簡化 RunImageGrid - 只顯示每步驟的選中圖片

**日期**：2025年9月6日  
**目標**：實作簡化模式，顯示每個步驟的最終選中圖片，按步驟順序排列，移除展開/收合功能

## 📋 原子化任務清單

### Phase 1: API 實作
- [ ] **Task 1.1** - 創建新 API 端點
  - 檔案：`app/api/runs/public/selected-items/route.ts`
  - 功能：接收 `runIds` 和 `slug` 參數
  - 輸出：返回每個 run 的被選中圖片

- [ ] **Task 1.2** - 實作核心查詢邏輯
  - 使用 `getFlowBySlug(slug)` 取得 flow 定義
  - 查詢 `flowRunSteps` 表，條件：`r2Key IS NOT NULL`
  - 過濾只保留 flow.steps 中定義的 stepId

- [ ] **Task 1.3** - 實作步驟排序邏輯
  - 根據 flow.steps 的順序對圖片排序
  - 處理不匹配的 stepId（跳過不顯示）
  - 確保每個 run 按相同步驟順序排列

- [ ] **Task 1.4** - API 錯誤處理
  - 驗證必要參數（runIds, slug）
  - 處理 flow 不存在的情況
  - 處理資料庫查詢錯誤

- [ ] **Task 1.5** - API 測試
  - 測試正常情況：有效的 runIds 和 slug
  - 測試邊界情況：空 runIds、無效 slug
  - 測試資料一致性：確保排序正確

### Phase 2: 前端組件修改

- [ ] **Task 2.1** - 修改 Introduction 頁面 API 調用
  - 檔案：`app/flows/[slug]/introduction/page.tsx`
  - 修改 fetch 調用從 `items-batch` 改為 `selected-items`
  - 傳入 slug 參數

- [ ] **Task 2.2** - 簡化 RunImageGrid 配置
  - 移除不需要的 props：`allowExpand`, `collapsedItemLimit`
  - 設定固定配置：不顯示展開/收合按鈕
  - 確保圖片網格正常顯示

- [ ] **Task 2.3** - 修改 History 頁面 API 調用
  - 檔案：`app/flows/[slug]/history/page.tsx`
  - 使用相同的新 API 端點
  - 保持現有的 UI 佈局

### Phase 3: UI/UX 優化

- [ ] **Task 3.1** - 優化圖片載入體驗
  - 確保圖片按步驟順序載入
  - 添加載入狀態指示器
  - 處理圖片載入失敗情況

- [ ] **Task 3.2** - 步驟進度視覺化
  - 考慮添加步驟標籤或編號
  - 確保用戶能清楚看到工作流程進度
  - 保持視覺一致性

- [ ] **Task 3.3** - 響應式設計調整
  - 確保在不同螢幕尺寸下正常顯示
  - 優化移動端體驗
  - 測試圖片網格佈局

### Phase 4: 測試與驗證

- [ ] **Task 4.1** - 功能測試
  - 測試 Introduction 頁面顯示正確
  - 測試 History 頁面顯示正確
  - 確認圖片排序符合預期

- [ ] **Task 4.2** - 效能測試
  - 測試多個 runs 的載入速度
  - 確認記憶體使用正常
  - 測試大量圖片的處理

- [ ] **Task 4.3** - 邊界情況測試
  - 測試沒有圖片的 run
  - 測試部分步驟缺失圖片的情況
  - 測試 10+ 步驟的 flow

- [ ] **Task 4.4** - 向後兼容性驗證
  - 確認舊的 `items-batch` API 仍正常運作
  - 確認其他使用該 API 的地方不受影響
  - 準備未來的遷移計劃

### Phase 5: 文檔與清理

- [ ] **Task 5.1** - 更新 API 文檔
  - 記錄新的 `selected-items` API 規格
  - 標記舊 API 的使用狀況
  - 添加使用範例

- [ ] **Task 5.2** - 程式碼清理
  - 移除不再使用的 props 和配置
  - 清理測試檔案中的過時測試
  - 更新相關註釋

- [ ] **Task 5.3** - 效能監控設定
  - 添加新 API 的監控
  - 設定錯誤追蹤
  - 準備部署檢查清單

## 🎯 預期成果

1. **用戶體驗改善**：用戶能清楚看到每個步驟的最終結果，了解工作流程進度
2. **效能優化**：只載入必要的圖片，減少載入時間
3. **程式碼簡化**：移除複雜的展開/收合邏輯，降低維護成本
4. **向後兼容**：不影響現有功能，平滑升級

## 📊 預估時間

- Phase 1 (API): 2-3 小時
- Phase 2 (前端): 1-2 小時  
- Phase 3 (UI/UX): 1 小時
- Phase 4 (測試): 1-2 小時
- Phase 5 (文檔): 30 分鐘

**總計**：約 5.5-8.5 小時

## 🚨 風險與注意事項

1. **資料一致性**：確保 stepId 與 flow 定義匹配
2. **效能影響**：大量 runs 的查詢效能
3. **圖片載入**：R2 存儲的訪問穩定性
4. **錯誤處理**：優雅處理各種邊界情況

## 🎯 實作結果

### ✅ **已完成的功能**

1. **新 API 端點**：`/api/runs/public/selected-items`
   - 接收 `runIds` 和 `slug` 參數
   - 只返回被選中的圖片（runSteps 中 r2Key 不為 null）
   - 按時間排序（未來可改為按步驟排序）
   - 完整的錯誤處理和參數驗證

2. **Introduction 頁面優化**
   - 使用新的 `selected-items` API
   - 移除展開/收合功能（`showExpand: false`）
   - 增加預覽項目數量到 20

3. **History 頁面簡化**
   - 修改 history API 只查詢 runSteps
   - 移除 FlowHistory 組件中的展開功能
   - 簡化圖片載入邏輯

### 📊 **API 文檔**

#### **新 API**：`POST /api/runs/public/selected-items`

**請求格式**：
```json
{
  "runIds": ["run-id-1", "run-id-2"],
  "slug": "flow-slug"
}
```

**回應格式**：
```json
{
  "itemsByRun": {
    "run-id-1": [
      {
        "r2Key": "flows/cosplay-generation/.../image.png",
        "createdAt": "2025-08-31T03:38:27.000Z",
        "stepId": "step-uuid"
      }
    ]
  }
}
```

**錯誤回應**：
```json
{
  "error": "Flow not found"  // 或其他錯誤訊息
}
```

### 🔧 **技術實作細節**

1. **資料查詢優化**
   - 只查詢 `flowRunSteps` 表，不查詢 `flowRunStepAssets`
   - 過濾條件：`r2Key IS NOT NULL`
   - 公開驗證：`public = true`

2. **排序邏輯**
   - 目前按時間排序（`createdAt ASC`）
   - 預留步驟排序的擴展空間

3. **向後兼容性**
   - 舊的 `items-batch` API 保持不變
   - 新舊 API 並存，無影響

### ⚡ **效能表現**

- API 回應時間：~300ms
- 支援多個 runs 批量查詢
- 記憶體使用正常
- 圖片載入體驗良好

---

**準備就緒**：請確認任務清單，然後我們開始實作！
