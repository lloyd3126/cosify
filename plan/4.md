# 計劃 4：候選 Modal 與 3x 生成（無併發/無配額/固定三段溫度）

本計劃將在不調整資料庫 schema 的前提下，於 FlowRunner 新增三顆無文字 icon 按鈕（生成、3x 生成、已生成），並以 Modal 呈現候選影像；3x 生成採用單一模型、固定 prompt，但依序以 0.0 / 0.5 / 1.0 的 temperature 串行生成三張，預設將「最後一張」設為本步結果。

---

## 範圍與約束
- 前端：
  - 新增三顆無文字 icon 按鈕（生成、3x 生成、已生成）。
  - 候選以 Modal 呈現；可在 Modal 中「設為本步結果」、「下載」。
  - 3x 生成為「串行」執行，一次一張；不做併發與重試。
  - 預設採用最後一張（temperature=1.0）。
- 後端：
  - 沿用現有單張生成端點，僅新增可選的「變體儲存」行為（另存 variant 路徑，回傳唯一 key）。
  - 不改資料庫 schema；仍僅保存「採用中的那張」至 flow_run_steps。
- 非目標：
  - 不設計配額與限制、不做自動挑選最佳、不實作歷史候選完整持久化（可列入 Backlog）。

---

## 驗收標準（Acceptance Criteria）
- 主卡底部出現三顆無文字 icon 按鈕：
  1) 生成（沿用現有 WandSparkles）
  2) 3x 生成（沿用現有 RotateCw）
  3) 已生成（新 icon：Grid/Images/Layers 任選其一，建議 Grid）
- 點擊 3x 生成後，依序完成三張生成（0.0 → 0.5 → 1.0），過程中按鈕禁用；完成後自動以最後一張設為本步結果並更新主卡。
- 點擊「已生成」打開 Modal，能看到本步驟於本次會話的所有候選影像縮圖；每張提供「設為本步結果」「下載」。
- 現有單張「生成」結束後，該張也會被收錄在候選列表內。
- 未改動 DB schema；下游步驟仍僅依賴 `keys[step.id]` 單一 key。

---

## 原子任務清單（可依序執行）

### 1) 前端：FlowRunner UI 更新
- [ ] 在該步驟卡片底部區塊新增三顆 icon 按鈕（無文字）：
  - [ ] 生成（沿用現有 WandSparkles）
  - [ ] 3x 生成（沿用現有 RotateCw）
  - [ ] 已生成（新增 Grid/Images/Layers 其中之一；採用一致的大小與 hover 樣式）
- [ ] 生成中（任一請求進行中）時，禁用 生成/3x 生成 按鈕；已生成 按鈕仍可開啟 Modal 查看既有候選。

### 2) 前端：候選資料狀態管理（僅於本次會話維持）
- [ ] 為每個 imgGenerator step 新增候選列表狀態：`candidates[step.id]: string[]`，內容為 R2 keys。
- [ ] 單張生成完成後：
  - [ ] 將回傳的 `key` push 進 `candidates[step.id]`（若不存在則初始化）。
  - [ ] 將 `keys[step.id]` 設為該 key（沿用現有邏輯）。
- [ ] 3x 生成流程（詳見第 4 節）：完成每次生成後把 key push 到 candidates；最後一次完成後，同步 `keys[step.id] = lastKey`。
- [ ] 與既有 blob URL 快取邏輯對齊：候選縮圖也使用 `ensureBlobUrlForKey` 以避免重複下載。

### 3) 前端：候選 Modal 組件
- [ ] 新增通用 Modal（若無現成 Dialog 組件，建立簡易版，支援：開關、header、body、footer）。
- [ ] Modal Header：標題「已生成」、右上關閉。
- [ ] Modal Body：
  - [ ] Responsive grid（手機 2 欄、平板 3–4 欄、桌機 5 欄）。
  - [ ] 每張卡片顯示縮圖；hover/觸控顯示操作列。
  - [ ] 操作列包含：
    - [ ] 設為本步結果（點擊：更新 `keys[step.id] = candidateKey`，關閉 Modal；主卡同步更新）
    - [ ] 下載（沿用既有下載方法，透過 `/api/r2/${key}` 取回 Blob）
  - [ ] 已採用的影像顯示徽章（如右上角小勾）。
- [ ] Modal Footer：顯示統計「已生成 N 張」。
- [ ] 當 `candidates[step.id]` 為空時，Modal 顯示「尚無生成結果」。

### 4) 前端：3x 生成流程（串行 + 固定溫度）
- [ ] 在 3x 生成按鈕 handler 中，依序執行 3 次 `generate` API 呼叫：
  - [ ] 第 1 次：`temperature = 0.0`
  - [ ] 第 2 次：`temperature = 0.5`
  - [ ] 第 3 次：`temperature = 1.0`
- [ ] 每次完成後：
  - [ ] 把回傳 `key` push 到 `candidates[step.id]`
  - [ ] 可即時預取 blob URL 以提升 Modal 開啟速度
- [ ] 全部完成後：
  - [ ] 將 `keys[step.id]` 設為最後一次（1.0）的 `key`
  - [ ] 解除按鈕禁用狀態
- [ ] 生成過程中若任一張失敗：toast 顯示錯誤；不中斷後續（仍為串行，失敗則跳過當次）。

### 5) 後端：單張生成 API 的「變體儲存」支援（最小改動）
- [ ] 在 `POST /api/flows/[slug]/steps/[stepId]/generate` 的 body 增加可選欄位：`asVariant?: boolean`
- [ ] 當 `asVariant = true`：
  - [ ] 將輸出寫入 `flows/{slug}/{userId}/{runId}/{stepId}/variant-<timestamp>-<uuid>.png`
  - [ ] 回傳該變體 `key`
  - [ ] 不覆寫 flow_run_steps 的 `r2Key`（避免非採用中影像覆蓋）
- [ ] 當 `asVariant` 缺省或為 false：
  - [ ] 維持現行寫入 `flows/{slug}/{userId}/{runId}/{stepId}.png`，並更新 flow_run_steps（代表「採用中」）
- [ ] 前端 3x 串行策略：
  - [ ] 第 1、2 次以 `asVariant = true`；第 3 次以 `asVariant = false`（自動成為採用中）
  - [ ] 單張「生成」仍為 `asVariant = false`

### 6) 整合與驗證
- [ ] 單步驟流程測試：
  - [ ] 先按「生成」一次；再按「3x 生成」；開啟「已生成」Modal 應見 4 張；採用最後一張為主卡。
  - [ ] 僅按「3x 生成」；開啟「已生成」應見 3 張；主卡為最後一張。
- [ ] 下游步驟依賴：
  - [ ] 確認 `keys[step.id]` 更新後，下游 `referenceImgs` 仍能正確傳遞並生成。
- [ ] 體驗：
  - [ ] 生成中按鈕禁用；Modal 可開啟查看先前候選。
  - [ ] 下載功能可用；Lazy Load 生效；燈箱非必要（可後續加）。

### 7) 文件與清理
- [ ] 在 README 或開發筆記中補充：
  - [ ] 三顆按鈕用途與互動
  - [ ] 3x 生成的溫度配置
  - [ ] asVariant 行為說明與命名規則
- [ ] 確認不輸出敏感環境變數到前端；.env 僅供伺服器端使用。

---

## Backlog（後續可選）
- 歷史候選持久化：新增 `flow_run_step_assets` 表，將所有變體寫入，歷史頁可展開、改採用。
- 手動重命名或標籤候選，批次下載 Zip。
- 自動挑選最佳（畫面評分/人臉清晰度等）。
- 失敗重試與指數退避；配額與等級限制。

---

## 小貼士（實作細節建議）
- 候選縮圖請使用延遲載入，並沿用既有 blob URL 快取，開啟 Modal 時即時顯示。
- 按鈕無文字但需 aria-label 以利可及性（e.g., aria-label="生成" / "3x 生成" / "已生成"）。
- 變體命名含時間戳與 uuid，方便排序與避免碰撞。
