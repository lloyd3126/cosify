# 縮圖載入分析報告

## 1. Introduction 頁面 (`/flows/[slug]/introduction`)

### 資料載入流程：
1. **SSR 階段**：
   - 呼叫 `/api/runs/public/items-batch` API
   - 傳入 `demoRunIds` 陣列（從 flow.introduction.demo 取得）
   - 批量取得所有 demo run 的完整圖片清單

2. **API 回傳結構**：
   ```typescript
   {
     itemsByRun: {
       [runId]: [{ r2Key, createdAt, stepId }]
     }
   }
   ```

3. **FlowHistoryList 接收的資料**：
   ```typescript
   runs: [{
     runId: string,
     createdAt: string,
     itemsPreview: items.slice(0, 6), // 前 6 張作為預覽
     allItems: items,                 // 完整清單
     itemsTotal: items.length
   }]
   ```

### 縮圖載入順序：
1. **首次渲染**：顯示每個 run 的前 6 張圖片（根據螢幕大小：xs=3, md=5, lg=6）
2. **圖片載入**：透過 `<Image src="/api/r2/${r2Key}">` 載入縮圖
3. **載入完成**：觸發 `onLoad` 事件，呼叫 `ensureBlobUrlForKey(r2Key)` 預先快取 blob URL
4. **展開時**：直接顯示 `allItems`，無需額外 API 呼叫

## 2. History 頁面 (`/flows/[slug]/history`)

### 資料載入流程：
1. **初始載入**：
   - FlowHistory 元件 `useEffect` 觸發 `load(true)`
   - 呼叫 `/api/flows/${slug}/history?limit=5`
   - 取得分頁的 run 清單（每頁 5 個）

2. **API 回傳結構**：
   ```typescript
   {
     runs: [{
       runId: string,
       createdAt: string,
       itemsPreview: [{ r2Key, createdAt }], // 最多 6 張預覽
       itemsTotal: number
     }],
     nextCursor: string | null
   }
   ```

3. **FlowHistoryList 接收的資料**：
   ```typescript
   runs: [{
     runId: string,
     createdAt: string,
     itemsPreview: [{ r2Key, createdAt }],
     allItems: expanded[runId] || undefined, // 只有展開後才有
     itemsTotal: number
   }]
   ```

### 縮圖載入順序：
1. **首次渲染**：顯示每個 run 的 `itemsPreview`（最多 6 張）
2. **圖片載入**：透過 `<Image src="/api/r2/${r2Key}">` 載入縮圖
3. **載入完成**：觸發 `onLoad` 事件，呼叫 `ensureBlobUrlForKey(r2Key)` 預先快取 blob URL
4. **展開時**：
   - 檢查 `expanded[runId]` 快取
   - 如無快取，呼叫 `/api/flows/${slug}/history/${runId}/items`
   - 取得完整清單後顯示所有圖片

## 3. 載入優化機制

### Blob URL 快取：
- **目的**：避免重複下載，提升 lightbox 效能
- **觸發時機**：圖片 `onLoad` 事件
- **快取邏輯**：
  ```typescript
  onLoad={() => {
    setImageLoading(prev => ({ ...prev, [it.r2Key]: false }));
    // 預先載入 blob URL 以供 lightbox 使用
    void ensureBlobUrlForKey(it.r2Key).catch(() => {});
  }}
  ```

### 載入狀態管理：
- **Skeleton 佔位符**：避免圖片載入時的版面跳動
- **透明度過渡**：`opacity-0` → `opacity-100`
- **載入狀態**：`imageLoading[r2Key]` 追蹤每張圖片的載入狀態

## 4. 實際載入順序總結

### Introduction 頁面：
1. **SSR**：批量取得所有 demo runs 的完整資料
2. **渲染**：同時載入所有可見的縮圖（並行載入）
3. **預覽**：每個 run 顯示前 6 張（根據螢幕大小調整）
4. **快取**：圖片載入完成後自動快取 blob URL
5. **展開**：無需 API 呼叫，直接顯示完整清單

### History 頁面：
1. **初始**：載入第一頁 runs（5 個）
2. **渲染**：載入每個 run 的預覽縮圖（最多 6 張）
3. **分頁**：按需載入更多 runs
4. **快取**：圖片載入完成後自動快取 blob URL
5. **展開**：按需載入完整圖片清單
6. **懶載入**：只有展開時才載入該 run 的完整資料

## 5. 效能特點

### Introduction 頁面：
- ✅ **優點**：展開無延遲，資料完整
- ⚠️ **注意**：SSR 時間較長，需載入所有 demo 資料

### History 頁面：
- ✅ **優點**：分頁載入，初始載入快
- ✅ **優點**：按需載入，節省頻寬
- ⚠️ **注意**：展開時需等待 API 回應
