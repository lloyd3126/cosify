<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡æœå‹™æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        input,
        button {
            margin: 5px;
            padding: 8px;
        }

        img {
            max-width: 300px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>Cloudflare Images Worker æ¸¬è©¦å·¥å…·</h1>

    <div class="test-section">
        <h2>ğŸ“‹ æ­¥é©Ÿä¸€ï¼šæ‰¾åˆ°çœŸå¯¦çš„åœ–ç‰‡ Key</h2>
        <p>è«‹åˆ°ä½ çš„æ‡‰ç”¨ä¸­æ‰¾åˆ°ä»»ä¸€åœ–ç‰‡ï¼Œå³éµæª¢æŸ¥å…ƒç´ ï¼Œæ‰¾åˆ° src ä¸­çš„ r2Key</p>
        <p>ä¾‹å¦‚ï¼š<code>/api/r2/flows/xxxxx/runs/xxxxx/step_xxxxx.png</code></p>
        <p>é‚£éº¼ key å°±æ˜¯ï¼š<code>flows/xxxxx/runs/xxxxx/step_xxxxx.png</code></p>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª æ­¥é©ŸäºŒï¼šæ¸¬è©¦åœ–ç‰‡æœå‹™</h2>
        <label>åœ–ç‰‡ Key:</label>
        <input type="text" id="imageKey" placeholder="flows/xxxxx/runs/xxxxx/step_xxxxx.png" style="width: 400px;">
        <br>
        <label>å¯¬åº¦:</label>
        <select id="width">
            <option value="200">200px</option>
            <option value="400" selected>400px</option>
            <option value="600">600px</option>
            <option value="800">800px</option>
        </select>
        <label>å“è³ª:</label>
        <select id="quality">
            <option value="60">60%</option>
            <option value="70">70%</option>
            <option value="80" selected>80%</option>
            <option value="90">90%</option>
        </select>
        <br>
        <button onclick="testOriginal()">æ¸¬è©¦åŸå§‹åœ–ç‰‡</button>
        <button onclick="testOptimized()">æ¸¬è©¦å„ªåŒ–åœ–ç‰‡</button>
        <button onclick="clearResults()">æ¸…é™¤çµæœ</button>

        <div id="results"></div>
    </div>

    <script>
        function addResult(message, isSuccess = true) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testOriginal() {
            const key = document.getElementById('imageKey').value.trim();
            if (!key) {
                addResult('è«‹è¼¸å…¥åœ–ç‰‡ Key', false);
                return;
            }

            const originalUrl = `https://nien.cc/api/r2/${key}`;
            addResult(`ğŸ” æ¸¬è©¦åŸå§‹åœ–ç‰‡: ${originalUrl}`);

            try {
                const response = await fetch(originalUrl);
                if (response.ok) {
                    addResult(`âœ… åŸå§‹åœ–ç‰‡å­˜åœ¨ (${response.status})`);

                    // é¡¯ç¤ºåœ–ç‰‡
                    const img = document.createElement('img');
                    img.src = originalUrl;
                    img.alt = 'åŸå§‹åœ–ç‰‡';
                    img.onload = () => addResult('ğŸ“· åŸå§‹åœ–ç‰‡è¼‰å…¥æˆåŠŸ');
                    img.onerror = () => addResult('âŒ åŸå§‹åœ–ç‰‡è¼‰å…¥å¤±æ•—', false);
                    document.getElementById('results').appendChild(img);

                } else {
                    addResult(`âŒ åŸå§‹åœ–ç‰‡ä¸å­˜åœ¨ (${response.status}: ${response.statusText})`, false);
                }
            } catch (error) {
                addResult(`âŒ æ¸¬è©¦åŸå§‹åœ–ç‰‡å¤±æ•—: ${error.message}`, false);
            }
        }

        async function testOptimized() {
            const key = document.getElementById('imageKey').value.trim();
            const width = document.getElementById('width').value;
            const quality = document.getElementById('quality').value;

            if (!key) {
                addResult('è«‹è¼¸å…¥åœ–ç‰‡ Key', false);
                return;
            }

            const optimizedUrl = `https://images.nien.cc?key=${encodeURIComponent(key)}&w=${width}&q=${quality}`;
            addResult(`ğŸ” æ¸¬è©¦å„ªåŒ–åœ–ç‰‡: ${optimizedUrl}`);

            try {
                const response = await fetch(optimizedUrl);
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    addResult(`âœ… å„ªåŒ–åœ–ç‰‡æˆåŠŸ (${response.status}, ${contentType})`);

                    // é¡¯ç¤ºåœ–ç‰‡
                    const img = document.createElement('img');
                    img.src = optimizedUrl;
                    img.alt = 'å„ªåŒ–åœ–ç‰‡';
                    img.onload = () => addResult('ğŸ“· å„ªåŒ–åœ–ç‰‡è¼‰å…¥æˆåŠŸ');
                    img.onerror = () => addResult('âŒ å„ªåŒ–åœ–ç‰‡è¼‰å…¥å¤±æ•—', false);
                    document.getElementById('results').appendChild(img);

                } else {
                    const errorText = await response.text();
                    addResult(`âŒ å„ªåŒ–åœ–ç‰‡å¤±æ•— (${response.status}): ${errorText}`, false);
                }
            } catch (error) {
                addResult(`âŒ æ¸¬è©¦å„ªåŒ–åœ–ç‰‡å¤±æ•—: ${error.message}`, false);
            }
        }
    </script>
</body>

</html>
